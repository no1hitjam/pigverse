<html>
<head>

	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>PIGVERSE</title>
	<meta name="description" content="">
	<link rel="stylesheet" href="pico.css">
	<link rel="stylesheet" href="index.css">
	<meta name="viewport" content="user-scalable=no">

</head>

<body>

	<br><br><br>

	<div class="content">

		<div class="canvasContainer">

			<canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>

			<script type="text/javascript">
				var canvas = document.getElementById("canvas");
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;

				// show Emscripten environment where the canvas is
				// arguments are passed to PICO-8
				
				var Module = {};
				Module.canvas = canvas;
			
				// When pico8_buttons is defined, PICO-8 takes each int to be a live bitfield
				// representing the state of each player's buttons
				
				var pico8_buttons = [0, 0, 0, 0, 0, 0, 0, 0]; // max 8 players
				//pico8_buttons[0] = 2 | 16; // example: player 0, RIGHT and Z held down
				
				// when pico8_gpio is defined, reading and writing to gpio pins will
				// read and write to these values
				var pico8_gpio = new Array(128);
				
			</script>

			<script async type="text/javascript" src="pico8comjs.js"></script> <!-- Add to your html container. -->
			<script async type="text/javascript" src="index.js"></script>
				
			<script>
				// key blocker. prevent cursor keys from scrolling page while playing cart.
				
				function onKeyDown_blocker(event) {
					event = event || window.event;
					var o = document.activeElement;
					if (!o || o == document.body || o.tagName == "canvas")
					{
						if ([32, 37, 38, 39, 40].indexOf(event.keyCode) > -1)
						{
							if (event.preventDefault) event.preventDefault();
						}
					}
				}

				document.addEventListener('keydown', onKeyDown_blocker, false);

			</script>
		</div>

		<div id="controllerContainerContainer">
			<div id="controllerContainer">
				<div id="controllerDummy"></div>
				<div id="controllerElement">
					<div id="controllerDirButtons">
						<!--<div id="controllerUp" class="controllerDir"></div>
						<div id="controllerLeft" class="controllerDir"></div>
						<div id="controllerRight" class="controllerDir"></div>
						<div id="controllerDown" class="controllerDir"></div>-->
					</div>
					<div id="controllerActionButtons">
						<div id="controllerZ" class="controllerAction"></div>
						<div id="controllerX" class="controllerAction"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type="text/javascript">
		function pressJoyButton(evt, buttonIndex) {
			evt.preventDefault();
			var newButtons = pico8_buttons[0] | 1 << buttonIndex;
			pico8_buttons[0] = newButtons;
		}

		function releaseJoyButton(evt, buttonIndex) {
			evt.preventDefault();
			var newButtons = pico8_buttons[0] & (63 ^ 1 << buttonIndex);
			pico8_buttons[0] = newButtons;
		}

		function moveJoyStick(evt) {
			console.log(evt.clientX, evt.clientY);
		}

		function addButtonListeners(buttonName, buttonIndex) {
			document.getElementById(buttonName).addEventListener("touchstart", (evt) => pressJoyButton(evt, buttonIndex));
			document.getElementById(buttonName).addEventListener("touchend", (evt) => releaseJoyButton(evt, buttonIndex));
			document.getElementById(buttonName).addEventListener("mousedown", (evt) => pressJoyButton(evt, buttonIndex));
			document.getElementById(buttonName).addEventListener("mouseup", (evt) => releaseJoyButton(evt, buttonIndex));
		}
		/*addButtonListeners("controllerLeft", 0);
		addButtonListeners("controllerRight", 1);
		addButtonListeners("controllerUp", 2);
		addButtonListeners("controllerDown", 3);*/
		addButtonListeners("controllerZ", 4);
		addButtonListeners("controllerX", 5);		

		joyStickPressed = false;

		function joyStickValue(relX, relY) {
			if (Math.abs(relX) > Math.abs(relY) && relX > 0) {
				return 1;
			} else if (Math.abs(relY) > Math.abs(relX) && relY <= 0) {
				return 2;
			} else if (Math.abs(relY) > Math.abs(relX) && relY > 0) {
				return 3;
			}
			return 0;
		}

		$("#controllerDirButtons").mousedown(function(evt) {
			joyStickPressed = true;
		});

		$("#controllerDirButtons").mouseup(function(evt) {
			// release all dir buttons.
			releaseJoyButton(evt, 0);
			releaseJoyButton(evt, 1);
			releaseJoyButton(evt, 2);
			releaseJoyButton(evt, 3);

			joyStickPressed = false;
		});

		$("#controllerDirButtons").mousemove(function(evt) {
			if (joyStickPressed) {
				var parentOffset = $(this).parent().offset(); 
				var relX = ((evt.pageX - parentOffset.left) / $(this).width()) * 2 - 1;
				var relY = ((evt.pageY - parentOffset.top) / $(this).height()) * 2 - 1;

				pico8_buttons[0] = pico8_buttons[0] & 48; // clear dir bits
				var joyBits = 1 << joyStickValue(relX, relY);
				pico8_buttons[0] = pico8_buttons[0] | joyBits; //set active bit
			}
		});
		
	</script>

	<br><br>

</body></html>


